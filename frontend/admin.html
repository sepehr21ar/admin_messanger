<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†</title>
<style>
  body { font-family: Arial; padding: 20px; direction: rtl; background: #f5f5f5; }
  h2, h3 { color: #333; }
  input, button, select, textarea { display: block; width: 100%; margin: 5px 0; padding: 8px; font-size: 15px; }
  button { background: #2196F3; color: white; border: none; cursor: pointer; }
  button:hover { background: #0b7dda; }
  textarea { height: 80px; resize: none; }
  #msg { font-weight: bold; margin-top: 10px; color: green; }
  .section { background: white; padding: 15px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
  li { cursor: pointer; margin: 5px 0; }
  li.unread { font-weight: bold; }
</style>
</head>
<body>

<h2>ğŸ‘‘ Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†</h2>
<button onclick="logout()">Ø®Ø±ÙˆØ¬</button>

<!-- Ú©Ø§Ø±Ø¨Ø±Ø§Ù† -->
<div class="section">
<h3>ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
<button onclick="loadUsers()">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</button>
<ul id="users"></ul>
</div>

<!-- Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± -->
<div class="section">
<h3>â• Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±</h3>
<input id="new_username" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
<input id="new_password" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
<select id="new_role">
  <option value="user">Ú©Ø§Ø±Ø¨Ø±</option>
  <option value="admin">Ø§Ø¯Ù…ÛŒÙ†</option>
</select>
<button onclick="createUserHandler()">Ø§ÛŒØ¬Ø§Ø¯</button>
<p id="msg"></p>
</div>

<!-- Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… -->
<div class="section">
<h3>âœ‰ï¸ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…</h3>
<input id="title" placeholder="Ø¹Ù†ÙˆØ§Ù†">
<input id="uids" placeholder="ID Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: 1,2,3">
<textarea id="content" placeholder="Ù…ØªÙ† Ù¾ÛŒØ§Ù…"></textarea>
<button onclick="sendMessageHandler()">Ø§Ø±Ø³Ø§Ù„</button>
<p id="msgSend" style="color:green; font-weight:bold;"></p>
</div>

<!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ -->
<div class="section">
<h3>ğŸ“¥ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ</h3>
<button onclick="loadInbox()">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</button>
<ul id="inbox"></ul>
</div>

<!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ÛŒ -->
<div class="section">
<h3>ğŸ“¤ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ÛŒ</h3>
<button onclick="loadSent()">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</button>
<ul id="sent"></ul>
</div>

<!-- Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾ÛŒØ§Ù… -->
<div class="section">
<h3>ğŸ“„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾ÛŒØ§Ù…</h3>
<h4 id="view_title"></h4>
<p id="view_sender"></p>
<p id="view_content"></p>
</div>

<script src="./common.js"></script>
<script>
// ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø§Ø±Ù†Ø¯
if (!parseToken() || parseToken().role !== "admin") logout();

let usersCache = [];

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
async function loadUsers() {
  const res = await fetch(API_URL + "/admin/users", { headers: authHeaders() });
  const users = await res.json();
  usersCache = users; // Ú©Ø´ Ú©Ø±Ø¯Ù† Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± sent messages
  const list = document.getElementById("users");
  list.innerHTML = "";
  users.forEach(u => list.innerHTML += `<li>${u.id} - ${u.username} (${u.role})</li>`);
}

// Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±
async function createUserHandler() {
  const username = document.getElementById("new_username").value.trim();
  const password = document.getElementById("new_password").value.trim();
  const role = document.getElementById("new_role").value;
  const msgEl = document.getElementById("msg");

  if(!username || !password) { msgEl.innerText = "Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯"; return; }

  const res = await fetch(API_URL + "/admin/create-user", {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({ username, password, role })
  });
  const data = await res.json();
  msgEl.innerText = data.message;
  loadUsers();
}

// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
async function sendMessageHandler() {
  const titleVal = document.getElementById("title").value.trim();
  const contentVal = document.getElementById("content").value.trim();
  const uidsVal = document.getElementById("uids").value.trim();
  const msgEl = document.getElementById("msgSend");

  if(!titleVal || !contentVal || !uidsVal) { msgEl.innerText = "Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯"; return; }

  const ids = uidsVal.split(",").map(x => parseInt(x.trim()));
  const res = await fetch(API_URL + "/messages/send", {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({ title: titleVal, content: contentVal, user_ids: ids })
  });
  const data = await res.json();

  msgEl.innerText = data.message;
  setTimeout(() => { msgEl.innerText = ""; }, 3000);

  document.getElementById("title").value = "";
  document.getElementById("content").value = "";
  document.getElementById("uids").value = "";

  loadSent();
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ
async function loadInbox() {
  const res = await fetch(API_URL + "/messages/inbox", { headers: authHeaders() });
  const inbox = await res.json();
  const list = document.getElementById("inbox");
  list.innerHTML = "";
  inbox.forEach(m => {
    const li = document.createElement("li");
    li.textContent = `ğŸ“¨ ${m.title} â€” Ø§Ø²: ${m.sender || "Ø³ÛŒØ³ØªÙ…"}`;
    if(!m.is_read) li.classList.add("unread");
    li.onclick = () => openMessage(m.id, li);
    list.appendChild(li);
  });
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ÛŒ
async function loadSent() {
  const res = await fetch(API_URL + "/messages/sent", { headers: authHeaders() });
  const sent = await res.json();
  const list = document.getElementById("sent");
  list.innerHTML = "";
  sent.forEach(m => {
    const recipients = m.receivers ? m.receivers.map(u => u.username).join(", ") : "";
    const li = document.createElement("li");
    li.textContent = `ğŸ“¤ ${m.title} â†’ ${recipients}`;
    li.onclick = () => openSentMessage(m);
    list.appendChild(li);
  });
}

// Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… Ø¯Ø±ÛŒØ§ÙØªÛŒ
async function openMessage(id, li=null) {
  const res = await fetch(API_URL + `/messages/${id}`, { headers: authHeaders() });
  const m = await res.json();
  document.getElementById("view_title").innerText = m.title;
  document.getElementById("view_sender").innerText = "ÙØ±Ø³ØªÙ†Ø¯Ù‡: " + (m.sender || "Ø³ÛŒØ³ØªÙ…");
  document.getElementById("view_content").innerText = m.content;

  if(li && li.classList.contains("unread")) {
    await fetch(API_URL + `/messages/${id}/read`, { method:"POST", headers: authHeaders() });
    li.classList.remove("unread");
  }
}

// Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… Ø§Ø±Ø³Ø§Ù„ÛŒ
function openSentMessage(m) {
  document.getElementById("view_title").innerText = m.title;
  document.getElementById("view_sender").innerText = "ÙØ±Ø³ØªÙ†Ø¯Ù‡: " + (m.sender || parseToken()?.username || "Ø§Ø¯Ù…ÛŒÙ†");
  document.getElementById("view_content").innerText = m.content;
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
loadUsers().then(loadInbox);

</script>
</body>
</html>
